#include "aux_table.h"#include "nmachandle.h"#include "xtr2.h"libnet_t * lt;//struct mac_table_entry mac_t[];//MACµØÖ·±í;struct _host_table host_table[PORT_NUMBER];struct _mac_table *mac_table[PORT_NUMBER];int flow_mod_count=0;void refresh_rloc_port_table(struct _rloc_port_table rloc_port_table[]){	printf("*****************refresh_rloc_port_table***********************\n");	char write_dst_rloc[PORT_NUMBER][100];	int port,j;	init_connection();        u_int32_t  src_ipv6[4]={0x20010001,0x00000000,0x00000000,0x00000001};//2001:1::1	for(j=0;j<4;j++)	{		printf("################################%d:%x\n",j,src_ipv6[j]);		nmac_write(0x10801000+j, 1, &src_ipv6[j]);				}	//void free_space();	//sleep(10);	//u_int32_t *src_ipv6=0x00000001000000000000000020010001;//src_ipv6:2001:1::	rule_fream(8);		for(port=1;port<=4;port++){				printf("sizeof(write_dst_rloc[port_count])=%d",sizeof(write_dst_rloc[port]));		libnet_addr2name6_r(rloc_port_table[port].rloc,1,write_dst_rloc[port],sizeof(write_dst_rloc[port]));		printf("\n>>>>>>>>>>>>>>\t*****write_dst_rloc[%d]=%s\t******\n",port,write_dst_rloc[port]);				add_rule_action(CENGDIEWANG_MODE,0,write_dst_rloc[port],EN_LISP_N,DE_LISP_Y,RE_MAC_N,FORWARD_Y,port);//ÏÂ		add_rule_action(CENGDIEWANG_MODE,port,write_dst_rloc[port],EN_LISP_Y,DE_LISP_N,RE_MAC_Y,FORWARD_Y,0);//ÉÏ			}					write_to_NM();  //·ÅÔÚ×îºóÐŽÈë        	action_data_fream(4);	for(port=1;port<=4;port++)	{		printf(">>下发第%d条规则<<\n\t",port);		libnet_addr2name6_r(rloc_port_table[port].rloc,LIBNET_DONT_RESOLVE,write_dst_rloc[port],sizeof(write_dst_rloc[port]));				config_action_data("2001:1::1",write_dst_rloc[port],"12:12:12:12:12:02","12:12:12:12:12:01");	}	}//struct mac_table_entry ifit_t[TEST_SIZE];//œÓ¿ÚÐÅÏ¢Œò±í,ÒÔ¶Ë¿ÚºÅÎªË÷Òý;/* * ±ßÔµÍøÖ÷»ú±šÎÄ±í */ /* ŽòÓ¡±šÎÄ */ void pkt_print_aux_table(u8* pkt, int len) { 		//return;	 	printf("++++++++++++++pkt_print+++++++++++++\n");		 	printf("  ****************************************************  \n");	 	printf("  **********************len=%04d**********************  \n",len);	 	printf("  line 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16\n");	 	int flag=0;	 	int line=1;	 	printf("  000  ");	 	while(len!=0)	{					printf("%02X", *pkt);				printf(" ");					pkt++;				len--;				flag++;				if(flag==16)		{						if(line>=16)			{								printf("\n  %03X  ",line++);						}else			{								printf("\n  %03X  ",line++);			}						flag=0;				}		}		printf("\n");}int add_host_table(struct _host_table host_table[],int port,char* port_ip){	printf("add_host_table\n");	struct libnet_in6_addr p_ip;	p_ip	= libnet_name2addr6(lt, port_ip, LIBNET_DONT_RESOLVE);	host_table[port].port = port;	memcpy(&(host_table[port].port_ip),&(p_ip),sizeof(struct libnet_in6_addr));	return 0;}/*u8* find_host_ip_by_port(struct _host_table host_table[],int port){	return (u8 *)(host_table[port]);}*/int is_host_ip(struct _host_table host_table[],struct libnet_in6_addr dst_ip){	int i;	for(i = 1;i < PORT_NUMBER;i++)	{		if(memcmp(&host_table[i].port_ip,&dst_ip,sizeof(struct libnet_in6_addr)))			return i;			}return 0;}/* * ÊµÍøÏÂÐÐ * SUBID-PORT ±í */int add_subid_port_table(struct _subid_port_table subid_port_table[],int port,char* eid){	/*ŽøÐÞžÄchar eid ×ªÎªÊýŸÝœá¹¹£¬×ªÎª32Î» subid*/	struct libnet_in6_addr dst_eid;	dst_eid = libnet_name2addr6(lt,eid,LIBNET_DONT_RESOLVE);	memcpy((void *)&(subid_port_table[port].subid),(const void*)&dst_eid,8);//subid 32Î»	subid_port_table[port].port = port;		return 0;}int get_port_by_subid(struct _subid_port_table subid_port_table[],struct libnet_in6_addr dst_eid){	printf("get_port_by_subid\n");	int i;	for(i = 1; i < PORT_NUMBER; i++){		if(memcmp(&subid_port_table[i].subid,&(dst_eid),8))			return i;	}	printf("\nNOT GET THE PORT BY SUBID!\n");	return 0;}/* * ÊµÍøÉÏÐÐ * SUBID-RLOC ±í */int add_subid_rloc_table(struct _subid_rloc_table subid_rloc_table[],u64 subid,char* rloc){	/*ŽøÐÞžÄchar rloc ×ªÎªÊýŸÝœá¹¹£¬×ªÎª32Î» subid*/	printf("add_subid_rloc_table\n");	int i;	struct libnet_in6_addr dst_rloc;	/*SUBID_RLOC_TABLE_NUM subid-rloc±íÏîÊýÄ¿*/	for (i=0;i < SUBID_RLOC_TABLE_NUM;i++){		if(subid_rloc_table[i].subid == 0){			printf("subid_rloc_table[%d] NULL\n",i);			memcpy((u8 *)&subid_rloc_table[i].subid,&subid,8);					dst_rloc = libnet_name2addr6(lt,rloc,LIBNET_DONT_RESOLVE);			memcpy(&(subid_rloc_table[i].rloc),&(dst_rloc),sizeof(struct libnet_in6_addr));		}		else{			printf("subid_rloc_table[%d].subid=%llu\n",i,subid_rloc_table[i].subid);			pkt_print_aux_table((u8 *)&subid_rloc_table[i],24);		}	}	return 0;}int add_subid_rloc_table_struct(struct _subid_rloc_table subid_rloc_table[],u64 subid,struct libnet_in6_addr dst_rloc){	/*ŽøÐÞžÄchar rloc ×ªÎªÊýŸÝœá¹¹£¬×ªÎª32Î» subid*/	int i;	printf("add_subid_rloc_table_struct\n");	/*SUBID_RLOC_TABLE_NUM subid-rloc±íÏîÊýÄ¿*/	for (i=0;i < SUBID_RLOC_TABLE_NUM;i++){		if(subid_rloc_table[i].subid == 0){			memcpy((u8 *)&subid_rloc_table[i].subid,&subid,8);					//dst_rlocdst_rloc = libnet_name2addr6(lt,rloc,LIBNET_DONT_RESOLVE);			memcpy(&(subid_rloc_table[i].rloc),&(dst_rloc),sizeof(struct libnet_in6_addr));		}		else{			printf("subid_rloc_table[%d].subid=%llu\n",i,subid_rloc_table[i].subid);		}	}	printf("display_______subid_rloc_table_____\n");	pkt_print_aux_table((u8 *)&subid_rloc_table[0],SUBID_RLOC_TABLE_NUM*sizeof(struct _subid_rloc_table));	return 0;}u8* get_rloc_by_subid(struct _subid_rloc_table subid_rloc_table[],struct libnet_in6_addr dst_eid){	int i;	pkt_print_aux_table((u8 *)&dst_eid,16);	/*SUBID_RLOC_TABLE_NUM subid-rloc±íÏîÊýÄ¿*/	for (i=0;i < SUBID_RLOC_TABLE_NUM;i++){		printf("i=%d",i);		if(memcmp(&subid_rloc_table[i].subid,&(dst_eid),8)==0){			pkt_print_aux_table((u8*)&(subid_rloc_table[i].subid),16);			pkt_print_aux_table((u8*)&(subid_rloc_table[i].rloc),16);			return ((u8*)&(subid_rloc_table[i].rloc));		}	}	printf("not find dst_rloc!\n");	return NULL;}/* * ²ãµþÍø * RLOC-PORT(PORT-RLOC)±íÏîÌíŒÓ */int add_rloc_port_table(struct _rloc_port_table rloc_port_table[],int port_add,struct libnet_in6_addr rloc,int total_flow_number){		if(ntohl(port_add)>7){		while(1){				printf("port_number =%d--\n\t\t\tit's wrong!!!!\n",ntohl(port_add));				sleep(1);		}	}	pkt_print_aux_table((u8 *)&(rloc_port_table[0]),20*PORT_NUMBER);	rloc_port_table[ntohl(port_add)].port = port_add;	printf("add_rloc_port_table+++\n");	memcpy((void *)&(rloc_port_table[ntohl(port_add)].rloc),&rloc,sizeof(struct libnet_in6_addr));	printf("add_rloc_port_table---+++\n");	printf("add_rloc_port_table----end\n");	pkt_print_aux_table((u8 *)&(rloc_port_table[0]),20*PORT_NUMBER);		if(++flow_mod_count==total_flow_number){		printf(">>\tflow_mod_count=%d\n\n",flow_mod_count);		printf(">>\t\trefresh_rloc_port_table");		flow_mod_count=0;		refresh_rloc_port_table(r_p_t);	}else{		printf(">>\tflow_mod_count=%d",flow_mod_count);	}	return 0;}/* * ²ãµþÍøÏÂÐÐ * Íš¹ýRLOC²éÕÒPORTÊä³ö */int get_port_by_rloc(struct _rloc_port_table rloc_port_table[],struct libnet_in6_addr rloc){	int i;	for(i = 1; i < PORT_NUMBER; i++){		if(memcmp(&(rloc_port_table[i].rloc),&rloc,sizeof(struct libnet_in6_addr)))			return i;	}	printf("\nNOT GET THE PORT BY SUBID!\n");	return 0;}/* * ²ãµþÍøÉÏÐÐ * Íš¹ýPORT²éÕÒRLOC·â×° */u8* get_rloc_by_port(struct _rloc_port_table rloc_port_table[],int port){	return (u8 *)&(rloc_port_table[port]);}/*mac±í*/void add_mac_table(struct _mac_table mac_table[],int port,u8 *mac,int is_router,struct libnet_in6_addr *router_ip){	memcpy(&(mac_table[port].mac),mac,6);	mac_table[port].port = port;	mac_table[port].is_router = is_router;	if(is_router){		memcpy(&(mac_table[port].router_ip),router_ip,sizeof(struct libnet_in6_addr));	}	//return;}/*ND±í*/void add_nd_table(struct _nd_table nd_table[],struct libnet_in6_addr ip,u8 *dst_mac){	int i;	for (i=0; i < ND_TABLE_NUM;i++){		if(nd_table[i].flag==0){			printf("nd_table[%d].flag=%d\n",i,nd_table[i].flag);			memcpy(&(nd_table[i].dst_ip),&ip,sizeof(struct libnet_in6_addr));			memcpy(&(nd_table[i].mac),dst_mac,6);			nd_table[i].flag=1;			return;	}}	//return;}u8 *get_dst_mac_by_ip(struct _nd_table nd_table[],struct libnet_in6_addr *ip){	int i;	//char  _ip[128];  printf("get_dst_mac_by_ip-\n");	for (  i=0;i < ND_TABLE_NUM;i++)		{					printf("get_dst_mac_by_ip--\n");					//libnet_addr2name6_r(*ip,1,_ip,sizeof(_ip));					//printf("ip==========%s\n",_ip);					pkt_print ((u8 *)ip,16);					int value;					//value = memcmp((const void *)&(nd_table[i].dst_ip),(const void*)ip,16);					pkt_print_aux_table((u8 *)&(nd_table[i].dst_ip),16);					pkt_print_aux_table((u8 *)ip,16);					value = memcmp(&(nd_table[i].dst_ip),ip,16);					printf("i=%d\t-----value=%d\n",i,value);			if(value==0)			{				printf("\n\n\n++++++++++++++++++++++++nd_table[%d].mac++++++++\n\n\n\n\n",i);				pkt_print_aux_table ((u8 *)nd_table[i].mac,6);				return (u8 *)&(nd_table[i].mac);			}	   		}			printf("get_dst_mac_by_ip+\n");	return NULL;}